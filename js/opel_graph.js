
trustData = "trust	bed_occ\n\
BRADFORD TEACHING HOSPITALS 	69.9\n\
WIRRAL UNIVERSITY TEACHING HOSPITAL 	82.40\n\
ST HELENS AND KNOWSLEY 	90.90\n\
LIVERPOOL HEART AND CHEST HOSPITAL 	83.00\n\
ALDER HEY CHILDREN'S 	51.40\n\
MID CHESHIRE HOSPITALS 	80.40\n\
THE CHRISTIE 	88.30\n\
YORK TEACHING HOSPITAL 	86.70\n\
HARROGATE AND DISTRICT 	81.80\n\
AIREDALE 	80.50\n\
SHEFFIELD CHILDREN'S 	71.00\n\
SOUTH TYNESIDE 	87.20\n\
AINTREE UNIVERSITY HOSPITAL 	90.30\n\
THE CLATTERBRIDGE CANCER CENTRE 	65.60\n\
LIVERPOOL WOMEN'S 	58.30\n\
THE WALTON CENTRE 	89.20\n\
BARNSLEY HOSPITAL 	76.60\n\
THE ROTHERHAM 	89.90\n\
LEEDS AND YORK PARTNERSHIP 	85.20\n\
SHEFFIELD TEACHING HOSPITALS 	90.60\n\
NORTHERN LINCOLNSHIRE AND GOOLE 	77.20\n\
EAST CHESHIRE 	86.00\n\
COUNTESS OF CHESTER HOSPITAL 	93.20\n\
CITY HOSPITALS SUNDERLAND 	79.80\n\
UNIVERSITY HOSPITAL OF SOUTH MANCHESTER 	85.90\n\
SALFORD ROYAL 	93.50\n\
BOLTON 	80.90\n\
TAMESIDE AND GLOSSOP INTEGRATED CARE 	92.10\n\
NORTH CUMBRIA UNIVERSITY HOSPITALS 	84.50\n\
CUMBRIA PARTNERSHIP 	80.70\n\
DONCASTER AND BASSETLAW HOSPITALS 	79.60\n\
ROYAL LIVERPOOL AND BROADGREEN 	92.70\n\
GATESHEAD HEALTH 	93.70\n\
LEEDS TEACHING HOSPITALS 	90.90\n\
WRIGHTINGTON, WIGAN AND LEIGH 	83.40\n\
PENNINE CARE 	99.60\n\
THE NEWCASTLE UPON TYNE HOSPITALS 	81.90\n\
NORTHUMBRIA HEALTHCARE 	80.60\n\
SOUTH TEES HOSPITALS 	84.70\n\
5 BOROUGHS PARTNERSHIP 	93.00\n\
UNIVERSITY HOSPITALS OF MORECAMBE BAY 	95.00\n\
HUMBER 	87.10\n\
NORTH TEES AND HARTLEPOOL 	84.00\n\
SOUTHPORT AND ORMSKIRK HOSPITAL 	77.10\n\
CENTRAL MANCHESTER UNIVERSITY HOSPITALS 	91.50\n\
MERSEY CARE 	86.70\n\
LANCASHIRE CARE 	95.30\n\
PENNINE ACUTE HOSPITALS 	82.30\n\
HULL AND EAST YORKSHIRE HOSPITALS 	81.90\n\
STOCKPORT 	86.60\n\
WARRINGTON AND HALTON HOSPITALS 	84.40\n\
CALDERDALE AND HUDDERSFIELD 	86.50\n\
TEES, ESK AND WEAR VALLEYS 	91.00\n\
NORTHUMBERLAND, TYNE AND WEAR 	82.80\n\
CHESHIRE AND WIRRAL PARTNERSHIP 	89.90\n\
ROTHERHAM DONCASTER AND SOUTH HUMBER 	76.10\n\
MID YORKSHIRE HOSPITALS 	85.90\n\
SOUTH WEST YORKSHIRE PARTNERSHIP 	78.70\n\
BLACKPOOL TEACHING HOSPITALS 	90.80\n\
LANCASHIRE TEACHING HOSPITALS 	93.50\n\
COUNTY DURHAM AND DARLINGTON 	78.40\n\
EAST LANCASHIRE HOSPITALS 	86.30\n\
LEEDS COMMUNITY HEALTHCARE 	88.70\n\
BRADFORD DISTRICT CARE 	88.50\n\
MANCHESTER MENTAL HEALTH AND SOCIAL CARE	94.40\n\
SHEFFIELD HEALTH & SOCIAL CARE 	85.80\n\
WORCESTERSHIRE HEALTH AND CARE 	89.40\n\
STAFFORDSHIRE AND STOKE ON TRENT 	94.80\n\
SOUTHEND UNIVERSITY HOSPITAL 	84.80\n\
WALSALL HEALTHCARE 	88.40\n\
BEDFORD HOSPITAL 	95.90\n\
LUTON AND DUNSTABLE UNIVERSITY HOSPITAL 	89.20\n\
THE QUEEN ELIZABETH HOSPITAL, KING'S LYNN, 	87.40\n\
MILTON KEYNES UNIVERSITY HOSPITAL 	87.00\n\
BASILDON AND THURROCK UNIVERSITY HOSPITALS 	96.90\n\
COLCHESTER HOSPITAL UNIVERSITY 	82.10\n\
CHESTERFIELD ROYAL HOSPITAL 	90.20\n\
PAPWORTH HOSPITAL 	78.90\n\
PETERBOROUGH AND STAMFORD HOSPITALS 	82.20\n\
JAMES PAGET UNIVERSITY HOSPITALS 	82.10\n\
IPSWICH HOSPITAL 	88.20\n\
CAMBRIDGE UNIVERSITY HOSPITALS 	88.40\n\
NOTTINGHAMSHIRE HEALTHCARE 	90.40\n\
SOUTH WARWICKSHIRE 	85.80\n\
UNIVERSITY HOSPITALS OF NORTH MIDLANDS 	92.60\n\
BURTON HOSPITALS 	87.60\n\
SHERWOOD FOREST HOSPITALS 	87.00\n\
COVENTRY AND WARWICKSHIRE 	92.90\n\
THE ROBERT JONES AND AGNES HUNT 	77.80\n\
THE ROYAL WOLVERHAMPTON 	89.20\n\
WYE VALLEY 	95.40\n\
GEORGE ELIOT HOSPITAL 	91.80\n\
BIRMINGHAM WOMEN'S 	52.00\n\
NORTH STAFFORDSHIRE COMBINED HEALTHCARE 	82.20\n\
NORFOLK AND NORWICH UNIVERSITY HOSPITALS 	88.40\n\
NORFOLK AND SUFFOLK 	85.10\n\
THE DUDLEY GROUP 	84.00\n\
KETTERING GENERAL HOSPITAL 	96.70\n\
NORTHAMPTON GENERAL HOSPITAL 	88.40\n\
NORTHAMPTONSHIRE HEALTHCARE 	94.70\n\
LINCOLNSHIRE PARTNERSHIP 	92.20\n\
BIRMINGHAM CHILDREN'S HOSPITAL 	86.10\n\
MID ESSEX HOSPITAL SERVICES 	91.40\n\
HINCHINGBROOKE HEALTH CARE 	77.20\n\
THE PRINCESS ALEXANDRA HOSPITAL 	94.60\n\
HEART OF ENGLAND 	82.30\n\
NORTH ESSEX PARTNERSHIP UNIVERSITY 	98.70\n\
SOUTH STAFFORDSHIRE AND SHROPSHIRE 	90.90\n\
THE ROYAL ORTHOPAEDIC HOSPITAL 	81.50\n\
UNIVERSITY HOSPITALS BIRMINGHAM 	96.30\n\
CAMBRIDGESHIRE AND PETERBOROUGH 	83.30\n\
DERBY TEACHING HOSPITALS 	85.50\n\
UNITED LINCOLNSHIRE HOSPITALS 	89.40\n\
UNIVERSITY HOSPITALS OF LEICESTER 	84.80\n\
WEST HERTFORDSHIRE HOSPITALS 	84.10\n\
EAST AND NORTH HERTFORDSHIRE 	84.70\n\
SOUTH ESSEX PARTNERSHIP UNIVERSITY 	96.20\n\
WORCESTERSHIRE ACUTE HOSPITALS 	88.00\n\
NOTTINGHAM UNIVERSITY HOSPITALS 	83.50\n\
SANDWELL AND WEST BIRMINGHAM HOSPITALS 	85.00\n\
DERBYSHIRE HEALTHCARE 	95.60\n\
BIRMINGHAM AND SOLIHULL MENTAL HEALTH 	95.90\n\
SHREWSBURY AND TELFORD HOSPITAL 	87.70\n\
NORFOLK COMMUNITY HEALTH AND CARE 	92.80\n\
LINCOLNSHIRE COMMUNITY HEALTH SERVICES 	77.40\n\
DERBYSHIRE COMMUNITY HEALTH SERVICES 	65.10\n\
COVENTRY AND WARWICKSHIRE 	88.10\n\
DUDLEY AND WALSALL MENTAL HEALTH 	88.30\n\
CAMBRIDGESHIRE COMMUNITY SERVICES 	29.00\n\
BIRMINGHAM COMMUNITY HEALTHCARE 	93.40\n\
BLACK COUNTRY PARTNERSHIP 	81.50\n\
BARTS HEALTH 	89.50\n\
LONDON NORTH WEST HEALTHCARE 	89.80\n\
ROYAL FREE LONDON 	86.90\n\
ROYAL NATIONAL ORTHOPAEDIC HOSPITAL 	68.30\n\
NORTH MIDDLESEX UNIVERSITY HOSPITAL 	91.30\n\
THE HILLINGDON HOSPITALS 	85.90\n\
NORTH EAST LONDON 	90.00\n\
KINGSTON HOSPITAL 	87.30\n\
BARKING, HAVERING AND REDBRIDGE UNIVERSITY 	94.40\n\
GUY'S AND ST THOMAS' 	79.20\n\
LEWISHAM AND GREENWICH 	82.60\n\
CROYDON HEALTH SERVICES 	93.60\n\
ST GEORGE'S UNIVERSITY HOSPITALS 	93.70\n\
KING'S COLLEGE HOSPITAL 	94.00\n\
THE WHITTINGTON HOSPITAL 	76.70\n\
WEST LONDON MENTAL HEALTH 	93.10\n\
GREAT ORMOND STREET HOSPITAL 	81.40\n\
MOORFIELDS EYE HOSPITAL 	75.10\n\
OXLEAS 	87.60\n\
THE ROYAL MARSDEN 	81.90\n\
CHELSEA AND WESTMINSTER HOSPITAL 	85.50\n\
HOMERTON UNIVERSITY HOSPITAL 	77.50\n\
SW LONDON AND ST GEORGE'S MENTAL HEALTH 	86.90\n\
BARNET, ENFIELD AND HARINGEY MENTAL HEALTH 	99.70\n\
UNIVERSITY COLLEGE LONDON HOSPITALS 	81.50\n\
ROYAL BROMPTON & HAREFIELD 	92.50\n\
CENTRAL AND NORTH WEST LONDON 	90.90\n\
EPSOM AND ST HELIER UNIVERSITY HOSPITALS 	77.50\n\
EAST LONDON 	82.10\n\
IMPERIAL COLLEGE HEALTHCARE 	80.90\n\
CENTRAL LONDON COMMUNITY HEALTHCARE 	82.00\n\
CAMDEN AND ISLINGTON 	91.10\n\
SOLENT 	87.20\n\
ISLE OF WIGHT 	89.30\n\
ROYAL SURREY COUNTY HOSPITAL 	78.20\n\
WESTON AREA HEALTH 	100.00\n\
YEOVIL DISTRICT HOSPITAL 	92.40\n\
UNIVERSITY HOSPITALS BRISTOL 	86.60\n\
TORBAY AND SOUTH DEVON 	84.50\n\
TAUNTON AND SOMERSET 	80.90\n\
DORSET COUNTY HOSPITAL 	82.30\n\
NORTHERN DEVON HEALTHCARE 	85.70\n\
ROYAL UNITED HOSPITALS BATH 	95.30\n\
POOLE HOSPITAL 	88.30\n\
SUSSEX COMMUNITY 	89.90\n\
FRIMLEY HEALTH 	93.40\n\
DORSET HEALTHCARE UNIVERSITY 	94.00\n\
THE ROYAL BOURNEMOUTH AND CHRISTCHURCH 	90.90\n\
ROYAL CORNWALL HOSPITALS 	83.90\n\
SOMERSET PARTNERSHIP 	87.90\n\
ROYAL DEVON AND EXETER 	85.20\n\
UNIVERSITY HOSPITAL SOUTHAMPTON 	90.20\n\
PORTSMOUTH HOSPITALS 	93.60\n\
ROYAL BERKSHIRE 	83.30\n\
CORNWALL PARTNERSHIP 	91.90\n\
PLYMOUTH HOSPITALS 	87.20\n\
GREAT WESTERN HOSPITALS 	94.00\n\
HAMPSHIRE HOSPITALS 	81.20\n\
DARTFORD AND GRAVESHAM 	96.00\n\
OXFORD HEALTH 	92.10\n\
SALISBURY 	86.80\n\
MEDWAY 	94.70\n\
QUEEN VICTORIA HOSPITAL 	60.20\n\
GLOUCESTERSHIRE HOSPITALS 	91.80\n\
OXFORD UNIVERSITY HOSPITALS 	88.40\n\
ASHFORD AND ST PETER'S HOSPITALS 	81.20\n\
SURREY AND SUSSEX HEALTHCARE 	89.40\n\
2GETHER 	81.30\n\
NORTH BRISTOL 	95.20\n\
AVON AND WILTSHIRE MENTAL HEALTH 	87.00\n\
EAST KENT HOSPITALS UNIVERSITY 	90.30\n\
SOUTHERN HEALTH 	91.30\n\
MAIDSTONE AND TUNBRIDGE WELLS 	95.00\n\
DEVON PARTNERSHIP 	95.10\n\
BERKSHIRE HEALTHCARE 	85.60\n\
SUSSEX PARTNERSHIP 	98.90\n\
EAST SUSSEX HEALTHCARE 	90.60\n\
BRIGHTON AND SUSSEX UNIVERSITY HOSPITALS 	92.10\n\
BUCKINGHAMSHIRE HEALTHCARE 	91.60\n\
SURREY AND BORDERS PARTNERSHIP 	92.50\n\
KENT AND MEDWAY NHS AND SOCIAL CARE	93.20\n\
WESTERN SUSSEX HOSPITALS 	93.10\n\
";

var data = [],
    svg,
    defs,
    gBrush,
    brush,
    main_xScale,
    mini_xScale,
    main_yScale,
    mini_yScale,
    main_yZoom,
    main_xAxis,
    main_yAxis,
    mini_width,
    textScale;

init();

function init() {

    loadData = d3.tsv.parse(trustData);
    //Create the random data
    for (i = 0; i < loadData.length; i++){
         var my_object = {};
    my_object.key = i;
    my_object.country = loadData[i].trust;
    my_object.value = loadData[i].bed_occ - 85.00;
    data.push(my_object);
    }
    data.sort(function(a,b) { return b.value - a.value; });

    /////////////////////////////////////////////////////////////
    ///////////////// Set-up SVG and wrappers ///////////////////
    /////////////////////////////////////////////////////////////

    //Added only for the mouse wheel
    var zoomer = d3.behavior.zoom()
        .on("zoom", null);

    var main_margin = {top: 10, right: 10, bottom: 30, left: 280},
        main_width = 600 - main_margin.left - main_margin.right,
        main_height = 500 - main_margin.top - main_margin.bottom;

    var mini_margin = {top: 10, right: 10, bottom: 30, left: 10},
        mini_height = 500 - mini_margin.top - mini_margin.bottom,
        mini_width = 100 - mini_margin.left - mini_margin.right;

    svg = d3.select("#chart").append("svg")
        .attr("class", "svgWrapper")
        .attr("width", main_width + main_margin.left + main_margin.right + mini_width + mini_margin.left + mini_margin.right)
        .attr("height", main_height + main_margin.top + main_margin.bottom)
        .call(zoomer)
        .on("wheel.zoom", scroll)
        //.on("mousewheel.zoom", scroll)
        //.on("DOMMouseScroll.zoom", scroll)
        //.on("MozMousePixelScroll.zoom", scroll)
        //Is this needed?
        .on("mousedown.zoom", null)
        .on("touchstart.zoom", null)
        .on("touchmove.zoom", null)
        .on("touchend.zoom", null);

    var mainGroup = svg.append("g")
        .attr("class","mainGroupWrapper")
        .attr("transform","translate(" + main_margin.left + "," + main_margin.top + ")")
        .append("g") //another one for the clip path - due to not wanting to clip the labels
        .attr("clip-path", "url(#clip)")
        .style("clip-path", "url(#clip)")
        .attr("class","mainGroup");

    var miniGroup = svg.append("g")
        .attr("class","miniGroup")
        .attr("transform","translate(" + (main_margin.left + main_width + main_margin.right + mini_margin.left) + "," + mini_margin.top + ")");

    var brushGroup = svg.append("g")
        .attr("class","brushGroup")
        .attr("transform","translate(" + (main_margin.left + main_width + main_margin.right + mini_margin.left) + "," + mini_margin.top + ")");

    /////////////////////////////////////////////////////////////
    ////////////////////// Initiate scales //////////////////////
    /////////////////////////////////////////////////////////////

    main_xScale = d3.scale.linear().range([0, main_width]);
    mini_xScale = d3.scale.linear().range([0, mini_width]);

    main_yScale = d3.scale.ordinal().rangeBands([0, main_height], 0.4, 0);
    mini_yScale = d3.scale.ordinal().rangeBands([0, mini_height], 0.4, 0);

    //Based on the idea from: http://stackoverflow.com/questions/21485339/d3-brushing-on-grouped-bar-chart
    main_yZoom = d3.scale.linear()
        .range([0, main_height])
        .domain([0, main_height]);

    //Create x axis object
    main_xAxis = d3.svg.axis()
        .scale(main_xScale)
        .orient("bottom")
        .ticks(6)
        //.tickSize(0)
        .outerTickSize(0);

    //Add group for the x axis
    d3.select(".mainGroupWrapper")
        .append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(" + 0 + "," + (main_height + 5) + ")");
;
    //Create y axis object
    main_yAxis = d3.svg.axis()
        .scale(main_yScale)
        .orient("left")
        .tickSize(0)
        .outerTickSize(0);

    //Add group for the y axis
    mainGroup.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(-5,0)")
        .attr("text-align", "left");

    /////////////////////////////////////////////////////////////
    /////////////////////// Update scales ///////////////////////
    /////////////////////////////////////////////////////////////

    //Update the scales
    main_xScale.domain(d3.extent(data, function(d) { return d.value; }));
    mini_xScale.domain(d3.extent(data, function(d) { return d.value; }));
    main_yScale.domain(data.map(function(d) { return d.country; }));
    mini_yScale.domain(data.map(function(d) { return d.country; }));

    //Create the visual part of the y axis
    d3.select(".mainGroup").select(".y.axis").call(main_yAxis);

    /////////////////////////////////////////////////////////////
    ///////////////////// Label axis scales /////////////////////
    /////////////////////////////////////////////////////////////

    textScale = d3.scale.linear()
        .domain([15,120])
        .range([12,6]);
        //.clamp(true);

    /////////////////////////////////////////////////////////////
    ///////////////////////// Create brush //////////////////////
    /////////////////////////////////////////////////////////////

    //What should the first extent of the brush become - a bit arbitrary this
    var brushExtent = Math.max( 1, Math.min( 40, Math.round(data.length*0.4) ) );

    brush = d3.svg.brush()
        .y(mini_yScale)
        .extent([mini_yScale(data[0].country), mini_yScale(data[brushExtent].country)])
        .on("brush", brushmove)
    //.on("brushend", brushend);

    //Set up the visual part of the brush
    gBrush = d3.select(".brushGroup").append("g")
        .attr("class", "brush")
        .call(brush);

    gBrush.selectAll(".resize")
        .append("line")
        .attr("x2", mini_width);

    gBrush.selectAll(".resize")
        .append("path")
        .attr("d", d3.svg.symbol().type("triangle-up").size(20))
        .attr("transform", function(d,i) {
            return i ? "translate(" + (mini_width/2) + "," + 4 + ") rotate(180)" : "translate(" + (mini_width/2) + "," + -4 + ") rotate(0)";
        });

    gBrush.selectAll("rect")
        .attr("width", mini_width);

    //On a click recenter the brush window
    gBrush.select(".background")
        .on("mousedown.brush", brushcenter)
        .on("touchstart.brush", brushcenter);

    ///////////////////////////////////////////////////////////////////////////
    /////////////////// Create a rainbow gradient - for fun ///////////////////
    ///////////////////////////////////////////////////////////////////////////

    defs = svg.append("defs");

    //Create two separate gradients for the main and mini bar - just because it looks fun
    createGradient("positiveGradient", "60%", ['#fee0d2','#fc9272','#de2d26']);
    createGradient("negativeGradient", "60%", ['#31a354','#a1d99b', '#e5f5e0']);

    //Add the clip path for the main bar chart
    defs.append("clipPath")
        .attr("id", "clip")
        .append("rect")
        .attr("x", -main_margin.left)
        .attr("width", main_width + main_margin.left)
        .attr("height", main_height);

    /////////////////////////////////////////////////////////////
    /////////////// Set-up the mini bar chart ///////////////////
    /////////////////////////////////////////////////////////////

    //The mini brushable bar
    //DATA JOIN
    var mini_bar = d3.select(".miniGroup").selectAll(".bar")
        .data(data, function(d) { return d.key; });

    //UDPATE
    mini_bar
        .attr("width", function(d) { return Math.abs(mini_xScale(d.value) - mini_xScale(0)); })
        .attr("y", function(d,i) { return mini_yScale(d.country); })
        .attr("height", mini_yScale.rangeBand());

    //ENTER
    mini_bar.enter().append("rect")
        .attr("class", function(d) { return "bar bar--" + (d.value < 0 ? "negative" : "positive"); })
        .attr("x", function(d) { return mini_xScale(Math.min(0, d.value)); })
        .attr("width", function(d) { return Math.abs(mini_xScale(d.value) - mini_xScale(0)); })
        .attr("y", function(d,i) { return mini_yScale(d.country); })
        .attr("height", mini_yScale.rangeBand());
        //.style("fill", "url(#gradient-rainbow-mini)");

    //EXIT
    mini_bar.exit()
        .remove();

    //Start the brush
    gBrush.call(brush.event);

}//init

//Function runs on a brush move - to update the big bar chart
function update() {

    /////////////////////////////////////////////////////////////
    ////////// Update the bars of the main bar chart ////////////
    /////////////////////////////////////////////////////////////

    //DATA JOIN
    var bar = d3.select(".mainGroup").selectAll(".bar")
        .data(data, function(d) { return d.key; });

    //UPDATE
    bar
        .attr("y", function(d,i) { return main_yScale(d.country); })
        .attr("height", main_yScale.rangeBand())
        .attr("x", function(d) { return main_xScale(Math.min(0, d.value)); })
        .transition().duration(50)
        .attr("width", function(d) { return Math.abs(main_xScale(d.value) - main_xScale(0)); });

    //ENTER
    bar.enter().append("rect")
        .attr("class", function(d) { return "bar bar--" + (d.value < 0 ? "negative" : "positive"); })
        // .style("fill", "url(#gradient-rainbow-main)")
        .attr("y", function(d,i) { return main_yScale(d.country); })
        .attr("height", main_yScale.rangeBand())
        .attr("x", function(d) { return main_xScale(Math.min(0, d.value)); })
        .transition().duration(50)
        .attr("width", function(d) { return Math.abs(main_xScale(d.value) - main_xScale(0)); });

    //EXIT
    bar.exit()
        .remove();

}//update

/////////////////////////////////////////////////////////////
////////////////////// Brush functions //////////////////////
/////////////////////////////////////////////////////////////

//First function that runs on a brush move
function brushmove() {

    var extent = brush.extent();

    //Which bars are still "selected"
    var selected = mini_yScale.domain()
        .filter(function(d) { return (extent[0] - mini_yScale.rangeBand() + 1e-2 <= mini_yScale(d)) && (mini_yScale(d) <= extent[1] - 1e-2); });
    //Update the colors of the mini chart - Make everything outside the brush grey
    d3.select(".miniGroup").selectAll(".bar")
        .attr("class", function(d) { return "bar bar--" + (d.value < 0 ? "negative" : "positive"); });

    //Update the label size
    d3.select("#chart").selectAll(".y.axis text")
        .style("font-size", textScale(selected.length));

    /////////////////////////////////////////////////////////////
    ///////////////////// Update the axes ///////////////////////
    /////////////////////////////////////////////////////////////

    //Reset the part that is visible on the big chart
    var originalRange = main_yZoom.range();
    main_yZoom.domain( extent );

    //Update the domain of the x & y scale of the big bar chart
    main_yScale.domain(data.map(function(d) { return d.country; }));
    main_yScale.rangeBands( [ main_yZoom(originalRange[0]), main_yZoom(originalRange[1]) ], 0.4, 0);

    //Update the y axis of the big chart
    d3.select(".mainGroup")
        .select(".y.axis")
        .call(main_yAxis);

    //Find the new max of the bars to update the x scale
    var newMaxXScale = d3.extent(data, function(d) { return selected.indexOf(d.country) > -1 ? d.value : 0; });
    main_xScale.domain(newMaxXScale);

    //Update the x axis of the big chart
    d3.select(".mainGroupWrapper")
        .select(".x.axis")
        .transition().duration(50)
        .call(main_xAxis);

    //Update the big bar chart
    update();

}//brushmove

/////////////////////////////////////////////////////////////
////////////////////// Click functions //////////////////////
/////////////////////////////////////////////////////////////

//Based on http://bl.ocks.org/mbostock/6498000
//What to do when the user clicks on another location along the brushable bar chart
function brushcenter() {
    var target = d3.event.target,
        extent = brush.extent(),
        size = extent[1] - extent[0],
        range = mini_yScale.range(),
        y0 = d3.min(range) + size / 2,
        y1 = d3.max(range) + mini_yScale.rangeBand() - size / 2,
        center = Math.max( y0, Math.min( y1, d3.mouse(target)[1] ) );

    d3.event.stopPropagation();

    gBrush
        .call(brush.extent([center - size / 2, center + size / 2]))
        .call(brush.event);

}//brushcenter

/////////////////////////////////////////////////////////////
///////////////////// Scroll functions //////////////////////
/////////////////////////////////////////////////////////////

function scroll() {

    //Mouse scroll on the mini chart
    var extent = brush.extent(),
        size = extent[1] - extent[0],
        range = mini_yScale.range(),
        y0 = d3.min(range),
        y1 = d3.max(range) + mini_yScale.rangeBand(),
        dy = d3.event.deltaY,
        topSection;

    if ( extent[0] - dy < y0 ) { topSection = y0; }
    else if ( extent[1] - dy > y1 ) { topSection = y1 - size; }
    else { topSection = extent[0] - dy; }

    //Make sure the page doesn't scroll as well
    d3.event.stopPropagation();
    d3.event.preventDefault();

    gBrush
        .call(brush.extent([ topSection, topSection + size ]))
        .call(brush.event);

}//scroll

/////////////////////////////////////////////////////////////
///////////////////// Helper functions //////////////////////
/////////////////////////////////////////////////////////////

//Create a gradient
function createGradient(idName, endPerc, colours) {

    defs.append("linearGradient")
        .attr("id", idName)
        .attr("gradientUnits", "userSpaceOnUse")
        .attr("x1", "0%").attr("y1", "0%")
        .attr("x2", endPerc).attr("y2", "0%")
        .selectAll("stop")
        .data(colours)
        .enter().append("stop")
        .attr("offset", function(d,i) { return i/(colours.length-1); })
        .attr("stop-color", function(d) { return d; });
}//createGradient


