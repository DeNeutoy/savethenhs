
var myData = "date	Awaiting completion of assessment	Awaiting public funding	Awaiting further non-acute NHS care	Awaiting residential home placement or availability	Awaiting nursing home placement or availability	Awaiting care package in own home	Awaiting community equipment and adaptations	Patient or family choice	Disputes	Housing â€“ patients not covered by NHS and Community Care Act\n\
20100801	967	322	753	560	595	601	122	757	101	162\n\
20100901	923	366	784	581	538	619	166	741	123	163\n\
20101001	936	296	746	595	522	481	155	646	60	151\n\
20101101	792	325	789	540	503	440	123	660	65	172\n\
20101201	767	257	734	463	421	392	74	552	59	142\n\
20110101	942	290	924	542	452	455	131	596	81	184\n\
20110201	861	286	833	525	419	484	157	610	78	151\n\
20110301	794	301	765	500	449	427	115	546	96	177\n\
20110401	778	226	717	419	410	432	142	537	73	176\n\
20110501	769	279	778	464	437	414	136	510	83	186\n\
20110601	841	247	704	462	429	458	148	610	73	165\n\
20110701	883	265	686	473	443	482	136	625	86	149\n\
20110801	794	259	764	481	477	437	137	565	79	151\n\
20110901	836	247	764	444	459	437	131	618	69	160\n\
20111001	745	238	771	457	478	454	138	624	90	155\n\
20111101	854	253	791	480	413	419	115	582	75	183\n\
20111201	792	198	742	428	377	329	83	475	52	141\n\
20120101	799	205	868	496	450	395	110	561	53	157\n\
20120201	769	216	838	474	463	400	122	531	73	121\n\
20120301	803	243	803	462	414	431	121	562	53	136\n\
20120401	850	227	747	465	393	380	106	551	71	164\n\
20120501	767	220	754	443	427	383	125	521	65	152\n\
20120601	886	203	850	399	415	403	134	564	66	166\n\
20120701	787	187	786	456	423	408	119	639	73	153\n\
20120801	836	205	723	422	444	431	126	578	44	152\n\
20120901	850	213	777	449	440	394	130	633	68	148\n\
20121001	860	209	803	440	434	428	139	600	68	134\n\
20121101	826	203	736	465	416	363	126	548	63	148\n\
20121201	817	170	651	423	337	317	83	440	83	127\n\
20130101	883	219	882	485	418	435	103	546	73	144\n\
20130201	792	217	849	437	426	445	130	503	69	139\n\
20130301	830	189	905	444	393	436	98	539	67	152\n\
20130401	867	215	890	459	422	383	133	481	56	140\n\
20130501	845	250	865	434	433	443	138	555	53	168\n\
20130601	775	246	777	418	398	399	142	519	56	158\n\
20130701	804	226	829	415	378	422	134	529	61	163\n\
20130801	841	197	827	441	461	445	92	566	51	163\n\
20130901	818	239	864	417	512	445	139	575	52	170\n\
20131001	840	208	805	439	481	466	116	595	32	165\n\
20131101	861	203	874	431	485	412	123	581	55	175\n\
20131201	695	161	780	390	479	388	93	464	52	147\n\
20140101	831	167	897	465	485	441	129	576	51	179\n\
20140201	791	194	970	455	485	447	134	609	49	142\n\
20140301	835	222	887	491	475	475	124	620	60	138\n\
20140401	871	190	832	464	492	480	109	562	47	160\n\
20140501	889	215	928	494	519	521	132	610	51	157\n\
20140601	957	205	845	408	520	484	135	600	65	144\n\
20140701	911	167	946	462	585	543	112	654	72	160\n\
20140801	990	206	818	490	620	583	126	674	66	131\n\
20140901	1021	197	898	511	660	598	139	742	55	139\n\
20141001	1094	216	845	492	681	621	128	683	44	126\n\
20141101	999	213	914	569	708	663	124	689	53	131\n\
20141201	841	194	917	482	597	692	89	498	36	129\n\
20150101	966	186	1188	530	678	758	127	621	46	121\n\
20150201	924	181	1062	541	600	717	133	592	66	126\n\
20150301	975	170	946	512	636	778	131	620	57	123\n\
20150401	969	197	894	511	569	755	109	525	68	142\n\
20150501	1004	210	929	499	603	787	133	605	56	146\n\
20150601	960	199	936	527	609	809	125	605	58	168\n\
20150701	805	191	944	515	584	865	141	634	52	157\n\
20150801	939	193	913	544	648	915	137	644	50	131\n\
20150901	996	186	982	518	644	904	156	645	59	157\n\
20151001	948	183	905	508	741	941	145	752	61	146\n\
20151101	992	247	962	556	756	941	164	729	68	158\n\
20151201	858	173	963	521	678	910	123	610	43	125\n\
20160101	1060	194	1069	590	770	1017	171	706	51	153\n\
20160201	1059	231	1031	593	786	956	149	697	58	167\n\
20160301	984	193	1031	559	776	1037	153	688	46	161\n\
20160401	1054	212	1048	568	810	1137	154	676	60	160\n\
20160501	976	240	1064	598	790	1210	185	721	74	152\n\
20160601	1041	251	1099	593	862	1134	166	727	82	166\n\
20160701	1037	242	1119	667	938	1242	168	706	85	160\n\
20160801	1071	213	1074	641	1020	1321	145	737	77	149\n\
20160901	1107	199	1123	677	1120	1452	136	756	66	141\n\
20161001	1113	250	1070	709	1040	1406	162	796	86	178\n\
20161101	1201	241	1048	709	1117	1378	135	750	73	173\n\
";


var margin = {
        top: 20,
        right: 80,
        bottom: 30,
        left: 80
    },
    width = 900 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

var parseDate = d3.time.format("%Y%m%d").parse;

var x_social = d3.time.scale()
    .range([0, width]);

var y_social = d3.scale.linear()
    .range([height, 0]);

var color = d3.scale.category10();

var xAxis = d3.svg.axis()
    .scale(x_social)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y_social)
    .orient("left");

var line = d3.svg.line()
    .interpolate("basis")
    .x(function(d) {
        return x_social(d.date);
    })
    .y(function(d) {
        return y_social(d.temperature);
    });

var transfers_svg = d3.select("#transfers").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var data = d3.tsv.parse(myData);

color.domain(d3.keys(data[0]).filter(function(key) {
    return key !== "date";
}));

data.forEach(function(d) {
    d.date = parseDate(d.date);
});

var cities = color.domain().map(function(name) {
    return {
        name: name,
        values: data.map(function(d) {
            return {
                date: d.date,
                temperature: +d[name]
            };
        })
    };
});

x_social.domain(d3.extent(data, function(d) {
    return d.date;
}));

y_social.domain([
    d3.min(cities, function(c) {
        return d3.min(c.values, function(v) {
            return v.temperature;
        });
    }),
    d3.max(cities, function(c) {
        return d3.max(c.values, function(v) {
            return v.temperature;
        });
    })
]);

var legend = transfers_svg.selectAll('g')
    .data(cities)
    .enter()
    .append('g')
    .attr('class', 'legend');

legend.append('rect')
    .attr('x', 28)
    .attr('y', function(d, i) {
        return i * 20;
    })
    .attr('width', 10)
    .attr('height', 10)
    .style('fill', function(d) {
        return color(d.name);
    });

legend.append('text')
    .attr('x', 40)
    .attr('y', function(d, i) {
        return (i * 20) + 9;
    })
    .text(function(d) {
        return d.name;
    });

transfers_svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis)
    .append("text")
    .attr("x", 350)
    .attr("y", 30)
    .style("text-anchor", "end")
    .text("Year");

transfers_svg.append("g")
    .attr("class", "y axis")
    .call(yAxis)
    .append("text")
    .attr("transform", "rotate(-90)")
    .attr("y", -65)
    .attr("x", -200)
    .attr("dy", ".71em")
    .style("text-anchor", "end")
    .text("Patients Delayed");

var city = transfers_svg.selectAll(".city")
    .data(cities)
    .enter().append("g")
    .attr("class", "city");

city.append("path")
    .attr("class", "line")
    .attr("d", function(d) {
        return line(d.values);
    })
    .style("stroke", function(d) {
        return color(d.name);
    });

var mouseG = transfers_svg.append("g")
    .attr("class", "mouse-over-effects");

mouseG.append("path") // this is the black vertical line to follow mouse
    .attr("class", "mouse-line")
    .style("stroke", "black")
    .style("stroke-width", "1px")
    .style("opacity", "0");

var lines = document.getElementsByClassName('line');

var mousePerLine = mouseG.selectAll('.mouse-per-line')
    .data(cities)
    .enter()
    .append("g")
    .attr("class", "mouse-per-line");

mousePerLine.append("circle")
    .attr("r", 7)
    .style("stroke", function(d) {
        return color(d.name);
    })
    .style("fill", "none")
    .style("stroke-width", "2px")
    .style("opacity", "0");

mousePerLine.append("text")
    .attr("transform", "translate(10,3)");

mouseG.append('svg:rect') // append a rect to catch mouse movements on canvas
    .attr('width', width) // can't catch mouse events on a g element
    .attr('height', height)
    .attr('fill', 'none')
    .attr('pointer-events', 'all')
    .on('mouseout', function() { // on mouse out hide line, circles and text
        d3.select(".mouse-line")
            .style("opacity", "0");
        d3.selectAll(".mouse-per-line circle")
            .style("opacity", "0");
        d3.selectAll(".mouse-per-line text")
            .style("opacity", "0");
    })
    .on('mouseover', function() { // on mouse in show line, circles and text
        d3.select(".mouse-line")
            .style("opacity", "1");
        d3.selectAll(".mouse-per-line circle")
            .style("opacity", "1");
        d3.selectAll(".mouse-per-line text")
            .style("opacity", "1");
    })
    .on('mousemove', function() { // mouse moving over canvas
        var mouse = d3.mouse(this);
        d3.select(".mouse-line")
            .attr("d", function() {
                var d = "M" + mouse[0] + "," + height;
                d += " " + mouse[0] + "," + 0;
                return d;
            });

        d3.selectAll(".mouse-per-line")
            .attr("transform", function(d, i) {
                console.log(width/mouse[0]);
                var xDate = x_social.invert(mouse[0]),
                    bisect = d3.bisector(function(d) { return d.date; }).right;
                idx = bisect(d.values, xDate);

                var beginning = 0,
                    end = lines[i].getTotalLength(),
                    target = null;

                while (true){
                    target = Math.floor((beginning + end) / 2);
                    pos = lines[i].getPointAtLength(target);
                    if ((target === end || target === beginning) && pos.x !== mouse[0]) {
                        break;
                    }
                    if (pos.x > mouse[0])      end = target;
                    else if (pos.x < mouse[0]) beginning = target;
                    else break; //position found
                }

                d3.select(this).select('text')
                    .text(y_social.invert(pos.y).toFixed(2));

                return "translate(" + mouse[0] + "," + pos.y +")";
            });
    });
